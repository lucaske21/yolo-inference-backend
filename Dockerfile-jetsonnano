# Use NVIDIA CUDA base image for GPU support
FROM ultralytics/ultralytics:8.4.11-jetson-jetpack4

# Set working directory
WORKDIR /app

# Install fastapi and uvicorn for serving the application
RUN pip3 install fastapi uvicorn

# Install python-multipart
RUN pip3 install python-multipart

# Verify installations and show versions
RUN python3 -c "import torch; import cv2; import numpy; print(f'PyTorch: {torch.__version__}'); print(f'OpenCV: {cv2.__version__}'); print(f'NumPy: {numpy.__version__}'); print(f'CUDA Available: {torch.cuda.is_available()}')"

# Copy application code
COPY src/ ./src/

# Create directories for model and output
RUN mkdir -p /app/config /app/output_img

# Environment variables with default values
ENV MODEL_PATH=/app/config \
    CONF_THRES=0.25 \
    IOU_THRES=0.45 \
    INPUT_SIZE=640 \
    OUTPUT_IMG_BASE_PATH=/app/output_img \
    HOST=0.0.0.0 \
    PORT=8000

# Expose the port
EXPOSE 8000

# Run the application
CMD ["python3", "src/app.py"]
